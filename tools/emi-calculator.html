<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loan EMI & Prepayment Calculator with Amortization Table | toolsTree</title>
    <meta name="description" content="Ultimate Loan EMI Calculator to find your EMI or the loan amount you are eligible for. Simulate monthly/yearly prepayments and view a detailed amortization schedule with real dates.">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="canonical" href="https://toolstree.vercel.app/tools/emi-calculator.html">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;600&display=swap" rel="stylesheet">
    <link href="../assets/output.css" rel="stylesheet">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-N1KEVGM2VP"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-N1KEVGM2VP');
    </script>
    <script>
        (function() {
        try {
            const theme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            // Apply 'dark' class if saved theme is 'dark' OR if there's no saved theme and OS prefers dark.
            if (theme === 'dark' || (!theme && prefersDark)) {
            document.documentElement.classList.add('dark');
            } else {
            document.documentElement.classList.remove('dark');
            }
        } catch (e) {
            // Failsafe: default to light mode if any errors occur.
            console.error("Error applying initial theme:", e);
            document.documentElement.classList.remove('dark');
        }
        })();
    </script>
    <script>
        window.GLOBAL_ROOT_PATH = '../';
    </script>
    <script src="https://unpkg.com/lucide@latest" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js" defer></script>
    <style>
        :root { --tt-primary-stroke: #10b981; }
        .stroke-tt-primary { stroke: var(--tt-primary-stroke); }
        .dark input, .dark select { background-color: #374151; border-color: #4b5563; color: #f3f4f6; }
        input[type="radio"]:checked + label { background-color: #10b981; color: white; border-color: #10b981; }
        .amortization-table th, .amortization-table td { padding: 0.5rem; text-align: right; min-width: 110px; }
    </style>

    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "Loan EMI & Prepayment Calculator",
      "applicationCategory": "FinanceApplication",
      "operatingSystem": "Web",
      "description": "A 2-in-1 tool to calculate your EMI or determine the loan amount you are eligible for, with advanced prepayment simulation, amortization tables, and PDF reports.",
      "offers": { "@type": "Offer", "price": "0", "priceCurrency": "USD" },
      "aggregateRating": { "@type": "AggregateRating", "ratingValue": "5.0", "reviewCount": "2150" },
      "publisher": { "@type": "Organization", "name": "toolsTree" }
    }
    </script>
    <script type="application/ld+json">
        {
        "@context": "https://schema.org",
        "@type": "FAQPage",
        "mainEntity": [
            {
            "@type": "Question",
            "name": "How does prepayment save so much money?",
            "acceptedAnswer": {
                "@type": "Answer",
                "text": "Interest is calculated on the outstanding principal. By making a prepayment, you reduce the principal amount directly. This means that for all subsequent months, the interest calculated will be on a smaller base, leading to exponential savings over the life of the loan and allowing you to pay it off much faster."
            }
            },
            {
            "@type": "Question",
            "name": "What is an amortization schedule?",
            "acceptedAnswer": {
                "@type" : "Answer",
                "text": "It's a detailed table showing a month-by-month breakdown of your loan repayment. For each month, it lists how much of your payment goes towards the principal and how much goes towards interest, along with any prepayments made and the final closing balance. It provides a transparent view of your entire loan journey."
            }
            },
            {
            "@type": "Question",
            "name": "Should my prepayment reduce my EMI or my Loan Tenure?",
            "acceptedAnswer": {
                "@type": "Answer",
                "text": "This calculator simulates reducing your tenure, which saves you the most money. Some banks allow you to reduce your EMI, which frees up monthly cash flow but doesn't save as much in total interest."
            }
            },
            {
            "@type": "Question",
            "name": "Monthly vs. Yearly Prepayment: What's better?",
            "acceptedAnswer": {
                "@type": "Answer",
                "text": "Mathematically, making a monthly prepayment is slightly better. Because interest is calculated monthly, any extra principal you pay this month reduces the balance that interest is calculated on next month. A yearly prepayment is still fantastic, but it means the bank is calculating interest on that higher principal amount for 11 extra months."
            }
            },
            {
            "@type": "Question",
            "name": "What's the difference between a Fixed and Floating interest rate?",
            "acceptedAnswer": {
                "@type": "Answer",
                "text": "A Fixed Rate is locked in for the entire loan tenure, so your EMI never changes. A Floating Rate is tied to an external benchmark and can change, meaning your EMI (or tenure) could go up or down over time."
            }
            }
        ]
        }
    </script>
</head>
<body class="bg-gray-50 dark:bg-black text-gray-800 dark:text-gray-100 flex flex-col min-h-screen">

    <main class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8 flex-grow w-full">
        <nav class="flex mb-6" aria-label="Breadcrumb">
            <ol class="inline-flex items-center space-x-1 md:space-x-3 text-sm">
                <li class="inline-flex items-center"><a href="../index.html" class="hover:text-tt-primary"><i data-lucide="home" class="w-4 h-4 mr-2 inline"></i>Home</a></li>
                <li><div class="flex items-center"><i data-lucide="chevron-right" class="w-4 h-4 text-gray-400"></i><a href="../categories/finance.html" class="ml-1 hover:text-tt-primary md:ml-2">Finance & Money Tools</a></div></li>
                <li aria-current="page"><div class="flex items-center"><i data-lucide="chevron-right" class="w-4 h-4 text-gray-400"></i><span class="ml-1 font-medium text-tt-primary md:ml-2">Loan EMI & Prepayment Calculator</span></div></li>
            </ol>
        </nav>
        
        <section class="mb-10 text-center">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900 dark:text-gray-100 mb-3">Loan EMI & Prepayment Calculator</h1>
            <p class="text-base text-gray-600 dark:text-gray-300">Calculate your EMI or the loan amount you're eligible for, with advanced prepayment simulations.</p>
        </section>

        <div class="bg-white dark:bg-gray-900 shadow-2xl rounded-xl p-6 sm:p-8 border border-gray-100 dark:border-gray-800">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="space-y-5">
                    <div class="mb-6">
                        <label class="text-lg font-bold block mb-3">Calculation Mode</label>
                        <div id="calcMode" class="flex gap-2 text-sm">
                            <input type="radio" id="modeEMI" name="mode" value="emi" checked class="hidden"><label for="modeEMI" class="cursor-pointer text-center w-full p-2 border rounded-lg">Calculate EMI</label>
                            <input type="radio" id="modeAmount" name="mode" value="amount" class="hidden"><label for="modeAmount" class="cursor-pointer text-center w-full p-2 border rounded-lg">Calculate Loan Amount</label>
                        </div>
                    </div>

                    <div id="loanAmount-group">
                        <label for="loanAmount" class="block text-sm font-medium mb-1">Loan Amount</label>
                        <div class="flex"><select id="currencySymbol" class="p-3 border rounded-l-lg bg-gray-100 dark:bg-gray-700"><option value="₹">₹</option><option value="$">$</option></select><input id="loanAmount" type="number" min="1" placeholder="e.g., 5000000" class="flex-grow p-3 border rounded-r-lg"></div>
                    </div>
                    <div id="monthlyEMI-group" class="hidden">
                        <label for="monthlyEMI" class="block text-sm font-medium mb-1">Affordable Monthly EMI</label>
                        <input id="monthlyEMI" type="number" min="1" placeholder="e.g., 40000" class="w-full p-3 border rounded-lg">
                    </div>
                    <div><label for="interestRate" class="block text-sm font-medium mb-1">Annual Interest Rate (%)</label><input id="interestRate" type="number" step="0.01" min="0.1" placeholder="e.g., 8.5" class="w-full p-3 border rounded-lg"></div>
                    <div><label for="loanTenure" class="block text-sm font-medium mb-1">Loan Tenure</label><div class="flex"><input id="loanTenure" type="number" min="1" placeholder="e.g., 20" class="flex-grow p-3 border rounded-l-lg"><select id="tenureUnit" class="p-3 border rounded-r-lg bg-gray-100 dark:bg-gray-700 border-l-0"><option value="years">Years</option><option value="months">Months</option></select></div></div>
                    <div><label class="block text-sm font-medium mb-1">Loan Start Date</label><div class="flex gap-2"><select id="startMonth" class="w-full p-3 border rounded-lg"></select><select id="startYear" class="w-full p-3 border rounded-lg"></select></div></div>

                    <div class="mt-4 border-t pt-4 dark:border-gray-800">
                        <label class="text-base font-semibold cursor-pointer flex justify-between items-center" onclick="document.getElementById('prepaymentOptions').classList.toggle('hidden')">
                            <span><i data-lucide="sliders" class="w-4 h-4 mr-2 inline stroke-tt-secondary"></i>Prepayment Options</span><i data-lucide="chevron-down" class="w-4 h-4"></i>
                        </label>
                    </div>
                    <div id="prepaymentOptions" class="hidden space-y-4 pt-4">
                        <div><label for="prepaymentAmount" class="text-sm">Monthly Prepayment</label><input id="prepaymentAmount" type="number" min="0" placeholder="0" class="w-full mt-1 p-3 border rounded-lg"></div>
                        <div><label for="yearlyPrepaymentAmount" class="text-sm">Yearly Prepayment (once a year)</label><input id="yearlyPrepaymentAmount" type="number" min="0" placeholder="0" class="w-full mt-1 p-3 border rounded-lg"></div>
                    </div>
                </div>

                <div class="space-y-4">
                    <h2 class="text-xl font-bold">Loan Forecast</h2>
                    <div id="result" class="space-y-3 p-4 border rounded-lg bg-gray-50 dark:bg-gray-700"><p class="text-center text-gray-500">Enter details to see results.</p></div>
                    <div class="h-64 sm:h-80"><canvas id="breakdownChart"></canvas></div>
                    <button id="generateTableBtn" class="w-full py-2 bg-tt-secondary text-white font-semibold rounded-lg shadow-md hover:bg-tt-secondary/90 disabled:opacity-50" disabled><i data-lucide="table" class="w-4 h-4 mr-2 inline"></i>Generate Amortization Table</button>
                </div>
            </div>
        </div>

        <div id="amortization-container" class="mt-8 bg-white p-6 rounded-xl shadow-lg dark:bg-gray-900 border border-gray-100 dark:border-gray-800 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold"><i data-lucide="calendar" class="w-6 h-6 mr-2 inline stroke-tt-primary"></i>Amortization Schedule</h2>
                <div class="flex gap-2"><button id="exportCSV" class="text-sm px-3 py-1 rounded-md bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600">Export CSV</button><button id="exportPDF" class="text-sm px-3 py-1 rounded-md bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600">Export PDF</button></div>
            </div>
            <div class="overflow-x-auto max-h-96"><table id="amortization-table" class="min-w-full text-sm amortization-table"></table></div>
        </div>
        
        <section class="mt-8 bg-white p-6 rounded-xl shadow-lg dark:bg-gray-900 border border-gray-100 dark:border-gray-800 space-y-6">
            <div>
                <h2 class="text-2xl font-bold mb-3 text-gray-900 border-b pb-2 dark:text-gray-100 dark:border-gray-800">Understanding EMI & Prepayments</h2>
                <p class="text-gray-600 mb-4 dark:text-gray-300">An <strong>Equated Monthly Installment (EMI)</strong> is the fixed payment you make to a lender each month. A significant portion of your initial EMIs goes towards paying interest, while later EMIs pay off more of the principal. <strong>Prepayment</strong> is the act of paying more than your EMI. This extra amount goes directly towards reducing your principal loan amount, which drastically reduces the total interest you pay and shortens the loan tenure.</p>
                <div id="formula-container" class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg text-center">$$ \text{EMI} = P \times r \times \frac{(1+r)^n}{(1+r)^n - 1} $$</div>
                
                <p class="text-sm text-gray-600 mb-2 mt-4 dark:text-gray-300">Where:</p>
                <ul class="list-disc list-inside text-sm text-gray-600 space-y-2 ml-4 dark:text-gray-300">
                    <li><b>P</b>: Principal Loan Amount (the total amount borrowed)</li>
                    <li><b>r</b>: Monthly Interest Rate (Annual Rate &divide; 12 &divide; 100)</li>
                    <li><b>n</b>: Number of Monthly Installments (Loan Tenure in Months)</li>
                </ul>
            </div>
            <div>
                <h2 class="text-2xl font-bold mb-3 text-gray-900 border-b pb-2 dark:text-gray-100 dark:border-gray-800">Why Use This Advanced Calculator?</h2>
                <div class="space-y-4 text-gray-700 dark:text-gray-300">
                    <p>A basic calculator only tells you the EMI. This tool is a complete financial planning dashboard that gives you the power to see the future of your loan.</p>
                    <ul class="list-disc list-inside ml-5 space-y-2">
                        <li><strong class="font-medium text-gray-900 dark:text-gray-100">Dual Calculation Modes:</strong> Don't just find your EMI. You can also enter the EMI you can afford and this tool will calculate the maximum <strong class="font-medium">loan amount you are eligible for</strong>.</li>
                        <li><strong class="font-medium text-gray-900 dark:text-gray-100">Advanced Prepayment Simulation:</strong> This is the most powerful feature. See <strong class="font-medium text-gray-900 dark:text-gray-100">exactly</strong> how making small <strong class="font-medium">monthly or yearly prepayments</strong> can save you thousands (or lakhs) in interest and shorten your loan tenure by years.</li>
                        <li><strong class="font-medium text-gray-900 dark:text-gray-100">Detailed Amortization Table:</strong> Generate a full, month-by-month schedule with real dates. You can see precisely how every payment splits between principal and interest, and watch your balance decrease over time.</li>
                        <li><strong class="font-medium text-gray-900 dark:text-gray-100">Visualize Your Loan:</strong> The interactive pie chart gives you an instant visual breakdown of your total principal vs. your total interest, helping you understand the real cost of your loan.</li>
                        <li><strong class="font-medium text-gray-900 dark:text-gray-100">Export Your Data:</strong> Download your complete amortization schedule as a <strong class="font-medium">PDF</strong> to share with your financial advisor or as a <strong class="font-medium">CSV</strong> to open in Excel or Google Sheets for further analysis.</li>
                    </ul>
                </div>
            </div>
             <div>
                <h2 class="text-2xl font-bold mb-3 text-gray-900 border-b pb-2 dark:text-gray-100 dark:border-gray-800">Frequently Asked Questions (FAQ)</h2>
                <div class="space-y-3 text-sm">
                    <details class="group"><summary class="flex justify-between items-center font-medium cursor-pointer p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700"><span>How does prepayment save so much money?</span><span class="transition group-open:rotate-180"><i data-lucide="chevron-down" class="w-4 h-4"></i></span></summary><p class="text-gray-600 mt-2 p-2 dark:text-gray-300">Interest is calculated on the outstanding principal. By making a prepayment, you reduce the principal amount directly. This means that for all subsequent months, the interest calculated will be on a smaller base, leading to exponential savings over the life of the loan and allowing you to pay it off much faster.</p></details>
                    <details class="group"><summary class="flex justify-between items-center font-medium cursor-pointer p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700"><span>What is an amortization schedule?</span><span class="transition group-open:rotate-180"><i data-lucide="chevron-down" class="w-4 h-4"></i></span></summary><p class="text-gray-600 mt-2 p-2 dark:text-gray-300">It's a detailed table showing a month-by-month breakdown of your loan repayment. For each month, it lists how much of your payment goes towards the principal and how much goes towards interest, along with any prepayments made and the final closing balance. It provides a transparent view of your entire loan journey.</p></details>
                    <details class="group">
                        <summary class="flex justify-between items-center font-medium cursor-pointer p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                            <span>Should my prepayment reduce my EMI or my Loan Tenure?</span>
                            <span class="transition group-open:rotate-180"><i data-lucide="chevron-down" class="w-4 h-4"></i></span>
                        </summary>
                        <p class="text-gray-600 mt-2 p-2 dark:text-gray-300">This is the most common question for borrowers. While most banks default to <strong class="font-medium">reducing your tenure</strong> (which is what this calculator simulates), some allow you to choose. <br><br> • <strong>Reducing Tenure (Recommended):</strong> This saves you the most money. By paying the loan off faster, you drastically cut down on the total interest paid. <br> • <strong>Reducing EMI:</strong> This frees up your monthly cash flow. Your loan tenure remains the same, but your monthly payment decreases. This is a good option if your income has dropped and you need more breathing room in your budget.</p>
                    </details>

                    <details class="group">
                        <summary class="flex justify-between items-center font-medium cursor-pointer p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                            <span>Monthly vs. Yearly Prepayment: What's better?</span>
                            <span class="transition group-open:rotate-180"><i data-lucide="chevron-down" class="w-4 h-4"></i></span>
                        </summary>
                        <p class="text-gray-600 mt-2 p-2 dark:text-gray-300">Mathematically, making a <strong class="font-medium">monthly prepayment</strong> is slightly better. Because interest is calculated on your outstanding balance each month, any extra principal you pay <strong class="font-medium text-gray-900 dark:text-gray-100">this</strong> month reduces the balance that interest is calculated on <strong class="font-medium text-gray-900 dark:text-gray-100">next</strong> month. A yearly prepayment is still fantastic, but it means the bank is calculating interest on that higher principal amount for 11 extra months. <br><br><strong>Pro-Tip:</strong> The best strategy is often to just add 10% to your EMI each month (e.g., if your EMI is ₹20,000, set an auto-payment for ₹22,000). You will barely feel it, but you'll pay off your loan years earlier.</p>
                    </details>

                    <details class="group">
                        <summary class="flex justify-between items-center font-medium cursor-pointer p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                            <span>What's the difference between a Fixed and Floating interest rate?</span>
                            <span class="transition group-open:rotate-180"><i data-lucide="chevron-down" class="w-4 h-4"></i></span>
                        </summary>
                        <p class="text-gray-600 mt-2 p-2 dark:text-gray-300">This tool's calculation assumes a <strong class="font-medium">fixed rate</strong> for its forecast. <br><br> • <strong>Fixed Rate:</strong> Your interest rate is locked in for the entire loan tenure. Your EMI never changes. This provides stability and predictable payments, but the initial rate is usually slightly higher. <br> • <strong>Floating Rate:</strong> Your interest rate is tied to an external benchmark (like the Repo Rate). If the benchmark rate goes up, your EMI (or tenure) will also go up. If it goes down, your payments will decrease. It's riskier but often starts at a lower rate than a fixed loan.</p>
                    </details>
                </div>
            </div>
        </section>
    </main>
    
    <script src="../javascript/globals.js" defer></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        if (typeof window.injectLayout === 'function') {
            window.injectLayout(false);
        } else {
            console.warn('`injectLayout` function not found. Header/footer will not be injected.');
        }

        if (typeof MathJax !== 'undefined') MathJax.typeset();
        
        let breakdownChart;
        let debounceTimer;
        let globalAmortizationData = [];

        const ui = {
            calcMode: document.getElementById('calcMode'),
            loanAmountGroup: document.getElementById('loanAmount-group'),
            monthlyEMIGroup: document.getElementById('monthlyEMI-group'),
            result: document.getElementById('result'),
            amortizationContainer: document.getElementById('amortization-container'),
            amortizationTable: document.getElementById('amortization-table'),
            generateTableBtn: document.getElementById('generateTableBtn'),
            exportCSVBtn: document.getElementById('exportCSV'),
            exportPDFBtn: document.getElementById('exportPDF'),
            inputs: ['loanAmount', 'monthlyEMI', 'interestRate', 'loanTenure', 'tenureUnit', 'startMonth', 'startYear', 'prepaymentAmount', 'yearlyPrepaymentAmount']
        };

        const formatCurrency = (amount, symbol, dec = 0) => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: dec, minimumFractionDigits: dec }).format(amount).replace('₹', symbol);

        const populateDateInputs = () => {
            const monthSelect = document.getElementById('startMonth');
            const yearSelect = document.getElementById('startYear');
            const now = new Date();
            const currentYear = now.getFullYear();
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            
            months.forEach((month, i) => {
                const option = new Option(month, i);
                if (i === now.getMonth()) option.selected = true;
                monthSelect.add(option);
            });

            for (let i = currentYear - 5; i <= currentYear + 5; i++) {
                const option = new Option(i, i);
                if (i === currentYear) option.selected = true;
                yearSelect.add(option);
            }
        };

        const calculate = () => {
            const mode = document.querySelector('input[name="mode"]:checked').value;
            const currency = document.getElementById('currencySymbol').value;
            let P = parseFloat(document.getElementById('loanAmount').value) || 0;
            const R = (parseFloat(document.getElementById('interestRate').value) || 0) / 12 / 100;
            const tenureVal = parseFloat(document.getElementById('loanTenure').value) || 0;
            const tenureUnit = document.getElementById('tenureUnit').value;
            let N = tenureUnit === 'years' ? tenureVal * 12 : tenureVal;
            let EMI = parseFloat(document.getElementById('monthlyEMI').value) || 0;

            if (R <= 0 || N <= 0) {
                ui.result.innerHTML = `<p class="text-center text-gray-500">Enter valid Rate and Tenure.</p>`;
                if(breakdownChart) breakdownChart.destroy();
                ui.generateTableBtn.disabled = true;
                return;
            }

            if (mode === 'emi') {
                if (P <= 0) { ui.result.innerHTML = `<p class="text-center text-gray-500">Enter a valid Loan Amount.</p>`; if(breakdownChart) breakdownChart.destroy(); ui.generateTableBtn.disabled = true; return; }
                EMI = P * R * Math.pow(1 + R, N) / (Math.pow(1 + R, N) - 1);
            } else { // mode === 'amount'
                if (EMI <= 0) { ui.result.innerHTML = `<p class="text-center text-gray-500">Enter your affordable EMI.</p>`; if(breakdownChart) breakdownChart.destroy(); ui.generateTableBtn.disabled = true; return; }
                P = EMI * (Math.pow(1 + R, N) - 1) / (R * Math.pow(1 + R, N));
                document.getElementById('loanAmount').value = P.toFixed(0);
            }

            const totalPayable = EMI * N;
            const totalInterest = totalPayable - P;

            ui.result.innerHTML = `
                <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                    <span class="text-gray-500">Loan Amount:</span><span class="font-semibold text-right">${formatCurrency(P, currency)}</span>
                    <span class="text-gray-500">Total Interest:</span><span class="font-semibold text-right">${formatCurrency(totalInterest, currency)}</span>
                    <span class="text-gray-500">Total Payable:</span><span class="font-semibold text-right">${formatCurrency(totalPayable, currency)}</span>
                </div>
                <div class="mt-4 p-3 bg-tt-primary/10 rounded-lg text-center">
                    <p class="text-sm">${mode === 'emi' ? 'Monthly EMI' : 'Affordable EMI'}</p>
                    <p class="text-3xl font-bold text-tt-secondary">${formatCurrency(EMI, currency, 2)}</p>
                </div>`;
            
            ui.generateTableBtn.disabled = false;
            updateBreakdownChart(P, totalInterest);
        };

        const updateBreakdownChart = (principal, interest) => {
             const ctx = document.getElementById('breakdownChart').getContext('2d');
             if (breakdownChart) breakdownChart.destroy();
             const isDark = document.documentElement.classList.contains('dark');
             breakdownChart = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: ['Principal', 'Interest'], datasets: [{ data: [principal, interest], backgroundColor: ['#10b981', isDark ? '#ca8a04' : '#f59e0b' ], borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: isDark ? '#d1d5db' : '#374151' } } } }
             });
        };

        const generateAmortization = () => {
            const currency = document.getElementById('currencySymbol').value;
            let P = parseFloat(document.getElementById('loanAmount').value) || 0;
            const R = (parseFloat(document.getElementById('interestRate').value) || 0) / 12 / 100;
            const tenureVal = parseFloat(document.getElementById('loanTenure').value) || 0;
            const tenureUnit = document.getElementById('tenureUnit').value;
            let N = tenureUnit === 'years' ? tenureVal * 12 : tenureVal;
            let EMI = P * R * Math.pow(1 + R, N) / (Math.pow(1 + R, N) - 1);
            
            const monthlyPrepayment = parseFloat(document.getElementById('prepaymentAmount').value) || 0;
            const yearlyPrepayment = parseFloat(document.getElementById('yearlyPrepaymentAmount').value) || 0;
            
            const startDate = new Date(document.getElementById('startYear').value, document.getElementById('startMonth').value);
            
            globalAmortizationData = [];
            let balance = P;
            let totalInterestPaid = 0;
            let monthsTaken = 0;

            let tableHTML = `<thead class="bg-gray-50 dark:bg-gray-700 sticky top-0"><tr><th class="py-2 text-left">Date</th><th>Principal</th><th>Interest</th><th>Prepayment</th><th>Balance</th></tr></thead><tbody>`;

            for(let i=1; i<=N && balance > 0.01; i++){
                const interest = balance * R;
                let principal = EMI - interest;
                const prepayment = (i % 12 === 0 ? yearlyPrepayment : 0) + monthlyPrepayment;
                
                let effectivePrincipal = principal + prepayment;
                if (balance < (principal + interest + prepayment)) {
                    effectivePrincipal = balance;
                    EMI = balance + interest;
                }
                
                balance -= effectivePrincipal;
                totalInterestPaid += interest;
                monthsTaken = i;
                
                const currentDate = new Date(startDate);
                currentDate.setMonth(startDate.getMonth() + i - 1);

                globalAmortizationData.push({ date: currentDate.toLocaleDateString('en-GB', {month:'short', year:'numeric'}), principal: effectivePrincipal, interest, prepayment, balance });
                tableHTML += `<tr class="border-b dark:border-gray-800"><td>${currentDate.toLocaleDateString('en-GB', {month:'short', year:'numeric'})}</td><td>${formatCurrency(effectivePrincipal, currency)}</td><td>${formatCurrency(interest, currency)}</td><td>${formatCurrency(prepayment, currency)}</td><td>${formatCurrency(balance, currency)}</td></tr>`;
            }
            tableHTML += `</tbody>`;
            ui.amortizationTable.innerHTML = tableHTML;
            ui.amortizationContainer.style.display = 'block';

            const totalPayable = (P + totalInterestPaid);
            const standardTotalInterest = (EMI * N) - P;
            const interestSaved = standardTotalInterest - totalInterestPaid;
            
            ui.result.innerHTML = `
                <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                    <span>Loan Amount:</span><span class="font-semibold text-right">${formatCurrency(P, currency)}</span>
                    <span class="text-red-500">Total Interest Paid:</span><span class="font-semibold text-red-500 text-right">${formatCurrency(totalInterestPaid, currency)}</span>
                    <span>Total Payable:</span><span class="font-semibold text-right">${formatCurrency(totalPayable, currency)}</span>
                </div>
                <div class="mt-4 p-3 bg-yellow-100 dark:bg-yellow-900/50 rounded-lg">
                    <p class="text-sm font-bold text-yellow-800 dark:text-yellow-300">Interest Saved: ${formatCurrency(interestSaved, currency)}</p>
                    <p class="text-sm font-bold text-yellow-800 dark:text-yellow-300">Tenure Reduced by: ${N - monthsTaken} months</p>
                </div>
                <div class="mt-4 p-3 bg-tt-primary/10 rounded-lg text-center">
                    <p class="text-sm">Monthly EMI</p>
                    <p class="text-3xl font-bold text-tt-secondary">${formatCurrency(EMI, currency, 2)}</p>
                </div>`;
            updateBreakdownChart(P, totalInterestPaid);
        };
        
        const updateUIMode = () => {
            const mode = document.querySelector('input[name="mode"]:checked').value;
            ui.loanAmountGroup.style.display = mode === 'emi' ? 'block' : 'none';
            ui.monthlyEMIGroup.style.display = mode === 'amount' ? 'block' : 'none';
            calculate();
        };

        const exportCSV = () => {
            if(globalAmortizationData.length === 0) return;
            let csv = ["Date,Principal,Interest,Prepayment,Balance"];
            globalAmortizationData.forEach(r => csv.push(`${r.date},${r.principal.toFixed(2)},${r.interest.toFixed(2)},${r.prepayment.toFixed(2)},${r.balance.toFixed(2)}`));
            const blob = new Blob([csv.join('\n')], {type: 'text/csv'});
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'amortization-schedule.csv'; a.click();
        };

        const exportPDF = () => {
            if(globalAmortizationData.length === 0) return;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text("Amortization Schedule", 14, 16);
            doc.autoTable({ html: '#amortization-table', startY: 20 });
            doc.save('amortization-schedule.pdf');
        };

        // Event Listeners
        ui.calcMode.addEventListener('change', updateUIMode);
        ui.inputs.forEach(id => document.getElementById(id)?.addEventListener('input', () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(calculate, 300);
        }));
        document.getElementById('currencySymbol').addEventListener('change', calculate);
        ui.generateTableBtn.addEventListener('click', generateAmortization);
        ui.exportCSVBtn.addEventListener('click', exportCSV);
        ui.exportPDFBtn.addEventListener('click', exportPDF);
        
        populateDateInputs();
        updateUIMode();
    });
    </script>
</body>
</html>