<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Next-Gen Favicon Generator Kit (ICO, PNG, Webmanifest) | toolsTree</title>
    <meta name="description" content="Create a complete favicon package from a single image, an emoji, or a Lucide icon. Generates ICO, PNG (16x16 to 512x512), Apple Touch Icons, and a webmanifest file for PWAs.">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="canonical" href="https://toolstree.vercel.app/tools/favicon-generator.html">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="../assets/output.css" rel="stylesheet">
    <style>
        :root { --tt-primary-stroke: #10b981; }
        .stroke-tt-primary { stroke: var(--tt-primary-stroke); }
        .dark input, .dark select { background-color: #374151; border-color: #4b5563; color: #f3f4f6; }
        input[type="radio"]:checked + label { background-color: #10b981; color: white; border-color: #10b981; }
        .color-input-container input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        .color-input-container input[type="color"]::-webkit-color-swatch { border: none; border-radius: 0.5rem; }
    </style>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-N1KEVGM2VP"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-N1KEVGM2VP');
    </script>
    <script>
    (function() {
        try {
            const theme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (theme === 'dark' || (!theme && prefersDark)) {
                document.documentElement.classList.add('dark');
            }
        } catch (e) { console.error("Error applying initial theme:", e); }
    })();
    </script>
    <script> window.GLOBAL_ROOT_PATH = '../'; </script>
    <script src="https://unpkg.com/lucide@latest" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <!-- ... (LD+JSON Schema and FAQ Schema are unchanged) ... -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "Next-Gen Favicon Generator Kit",
      "applicationCategory": "DeveloperApplication",
      "operatingSystem": "Web",
      "description": "Create a complete favicon package from a single image, an emoji, or a Lucide icon. Generates ICO, PNG (16x16 to 512x512), Apple Touch Icons, and a webmanifest file for PWAs.",
      "offers": { "@type": "Offer", "price": "0", "priceCurrency": "USD" },
      "publisher": { "@type": "Organization", "name": "toolsTree" }
    }
    </script>
    <script type="application/ld+json">
        {
        "@context": "https://schema.org",
        "@type": "FAQPage",
        "mainEntity": [
            {
            "@type": "Question",
            "name": "What is the best format for the source image?",
            "acceptedAnswer": {
                "@type": "Answer",
                "text": "For the best results, use a vector format like SVG. If you don't have an SVG, a high-resolution PNG (at least 512x512 pixels) with a transparent background is the next best choice. This allows the generator to scale the image down without losing quality."
            }
            },
            {
            "@type": "Question",
            "name": "What is a `site.webmanifest` file?",
            "acceptedAnswer": {
                "@type": "Answer",
                "text": "The `site.webmanifest` is a JSON file that tells the browser about your web application and how it should behave when 'installed' on a user's mobile or desktop device. It includes information like the app's name, icons, start URL, and theme colors, which are essential for Progressive Web Apps (PWAs)."
            }
            },
            {
            "@type": "Question",
            "name": "Where do I upload the generated files?",
            "acceptedAnswer": {
                "@type": "Answer",
                "text": "For best practice, all the generated files (e.g., `favicon.ico`, `apple-touch-icon.png`, `site.webmanifest`, etc.) should be placed in the root directory of your website. This is the main folder, the same place your `index.html` file usually lives."
            }
            },
            {
            "@type": "Question",
            "name": "How does the Emoji mode work?",
            "acceptedAnswer": {
                "@type": "Answer",
                "text": "The tool uses your browser's built-in font rendering to draw the emoji onto a canvas. It then exports this canvas image in all the required sizes. Using a single emoji character generally gives the clearest result."
            }
            },
            {
            "@type": "Question",
            "name": "What are Lucide Icons?",
            "acceptedAnswer": {
                "@type": "Answer",
                "text": "Lucide is a popular open-source icon library (lucide.dev) offering thousands of clean, consistent SVG icons. This tool lets you search and select any Lucide icon directly, color it, and generate a full favicon set from it â€“ perfect for developer projects or simple websites."
            }
            }
        ]
        }
    </script>
</head>
<body class="bg-gray-50 dark:bg-black text-gray-800 dark:text-gray-100 flex flex-col min-h-screen font-sans">
    <main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 flex-grow w-full">
        <nav class="flex mb-6" aria-label="Breadcrumb">
            <ol class="inline-flex items-center space-x-1 md:space-x-3 text-sm">
                <li class="inline-flex items-center"><a href="../index.html" class="hover:text-tt-primary"><i data-lucide="home" class="w-4 h-4 mr-2 inline"></i>Home</a></li>
                <li><div class="flex items-center"><i data-lucide="chevron-right" class="w-4 h-4 text-gray-400"></i><a href="../categories/image.html" class="ml-1 hover:text-tt-primary md:ml-2">Image & Design Tools</a></div></li>
                <li aria-current="page"><div class="flex items-center"><i data-lucide="chevron-right" class="w-4 h-4 text-gray-400"></i><span class="ml-1 font-medium text-tt-primary md:ml-2">Next-Gen Favicon Generator Kit</span></div></li>
            </ol>
        </nav>
        
        <section class="mb-10 text-center">
            <h1 class="text-3xl sm:text-4xl font-extrabold mb-3">Next-Gen Favicon Generator Kit</h1>
            <p class="text-base text-gray-600 dark:text-gray-300">Create a complete favicon package from an <strong>Image</strong>, an <strong>Emoji</strong>, or a <strong>Lucide Icon</strong>.</p>
        </section>

        <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
            <div class="lg:col-span-2 bg-white dark:bg-gray-900 shadow-xl rounded-xl p-6 sm:p-8 border border-gray-100 dark:border-gray-800 space-y-6">
                
                <div>
                    <h2 class="text-xl font-bold mb-3">1. Select Source</h2>
                    <div id="modeSelector" class="flex gap-2 text-sm border-b pb-4 dark:border-gray-800">
                        <input type="radio" id="modeImage" name="sourceMode" value="image" checked class="hidden">
                        <label for="modeImage" class="cursor-pointer text-center w-full p-2 border rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">Upload Image</label>
                        
                        <input type="radio" id="modeEmoji" name="sourceMode" value="emoji" class="hidden">
                        <label for="modeEmoji" class="cursor-pointer text-center w-full p-2 border rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">Use Emoji</label>

                        <input type="radio" id="modeIcon" name="sourceMode" value="icon" class="hidden">
                        <label for="modeIcon" class="cursor-pointer text-center w-full p-2 border rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">Use Lucide Icon</label>
                    </div>
                </div>

                <div id="imageMode" class="space-y-4">
                    <label for="imageUpload" class="flex flex-col items-center justify-center w-full h-48 border-2 border-dashed rounded-lg cursor-pointer bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 border-gray-300 dark:border-gray-500">
                        <div id="uploadPrompt" class="flex flex-col items-center justify-center pt-5 pb-6">
                            <i data-lucide="upload-cloud" class="w-10 h-10 mb-3 text-gray-400"></i>
                            <p class="mb-2 text-sm text-gray-500 dark:text-gray-400"><span class="font-semibold">Click to upload</span> or drag and drop</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">SVG, PNG, JPG (min 512x512 recommended)</p>
                        </div>
                        <img id="imagePreview" src="#" alt="Image Preview" class="hidden w-32 h-32 object-contain"/>
                        <input id="imageUpload" type="file" class="hidden" accept="image/png, image/jpeg, image/svg+xml">
                    </label>
                </div>
                
                <div id="emojiMode" class="space-y-4 hidden">
                    <label for="emojiInput" class="block text-sm font-medium mb-2">Paste or Type a Single Emoji (e.g., ðŸš€)</label>
                    <input type="text" id="emojiInput" maxlength="2" placeholder="âœ¨" class="text-6xl text-center w-full p-3 border rounded-lg dark:bg-gray-700" style="height: 192px;">
                    <p class="text-xs text-gray-500 dark:text-gray-400 text-center">Using a single character ensures the best quality result.</p>
                </div>

                <div id="iconMode" class="space-y-4 hidden">
                    <label for="iconSearch" class="block text-sm font-medium mb-2">Search Lucide Icons</label>
                    <input type="text" id="iconSearch" placeholder="e.g., search, user, feather" class="w-full p-2 border rounded-lg dark:bg-gray-700">
                    <div id="iconGrid" class="grid grid-cols-6 gap-2 p-3 border rounded-lg bg-gray-50 dark:bg-gray-900/50 max-h-48 overflow-y-auto">
                        <p class="col-span-6 text-center text-gray-500">Loading icons...</p>
                    </div>
                    
                    <button id="loadMoreBtn" class="hidden w-full mt-2 p-2 text-sm bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition">
                        Load More
                    </button>
                    
                    <div id="selectedIconPreview" class="text-center text-sm font-semibold h-6 mt-3">No icon selected.</div>
                    
                    <p class="text-xs text-gray-500 dark:text-gray-300 text-center mt-3">
                        <i data-lucide="info" class="w-3 h-3 inline mr-1"></i> Tip: If searching fails, find the exact name at 
                        <span id="lucideLink" class="text-tt-primary hover:underline cursor-pointer">lucide.dev</span> and paste it into the search bar.
                    </p>
                </div>

                <div>
                    <h2 class="text-xl font-bold mb-3">2. Customize Colors</h2>
                     <div class="space-y-4">
                        <label for="fgColor" class="block text-sm font-medium" id="fgColorLabel">Icon Color</label>
                        <div class="flex items-center gap-3">
                            <input type="color" id="fgColor" value="#10b981" class="p-1 h-10 w-10 block bg-white border border-gray-300 cursor-pointer rounded-lg disabled:opacity-50 disabled:pointer-events-none dark:bg-slate-900 dark:border-gray-800">
                            <input type="text" id="fgColorHex" value="#10b981" class="p-2 w-full border rounded-lg font-mono dark:bg-gray-700 dark:border-gray-600">
                        </div>

                        <label for="bgColor" class="block text-sm font-medium">Background Color (Padding)</label>
                        <div class="flex items-center gap-3">
                            <input type="color" id="bgColor" value="#FFFFFF" class="p-1 h-10 w-10 block bg-white border border-gray-300 cursor-pointer rounded-lg disabled:opacity-50 disabled:pointer-events-none dark:bg-slate-900 dark:border-gray-800">
                            <input type="text" id="bgColorHex" value="#FFFFFF" class="p-2 w-full border rounded-lg font-mono dark:bg-gray-700 dark:border-gray-600">
                        </div>
                        
                        <div class="flex items-center pt-2">
                            <input type="checkbox" id="transparentBg" class="h-4 w-4 rounded border-gray-300 dark:border-gray-600 text-tt-primary focus:ring-tt-primary">
                            <label for="transparentBg" class="ml-2 block text-sm">Transparent background (for PNGs)</label>
                        </div>
                        <p class="text-xs text-gray-500 -mt-2"><i data-lucide="info" class="w-3 h-3 inline-block mr-1"></i> `apple-touch-icon.png` will always receive a background for best results on iOS.</p>
                        </div>
                </div>

                 <div>
                    <h2 class="text-xl font-bold mb-3">3. Generate Your Kit</h2>
                    <button id="generateBtn" disabled class="w-full flex items-center justify-center gap-2 bg-tt-primary text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed">
                        <i data-lucide="package-check" class="w-5 h-5"></i>
                        <span>Generate & Download Kit</span>
                    </button>
                    <p id="statusText" class="text-center text-sm mt-3 text-gray-500"></p>
                </div>
            </div>

            <div id="resultsPanel" class="lg:col-span-3 space-y-6">
                 <div class="bg-white p-6 rounded-xl shadow-xl dark:bg-gray-900 border dark:border-gray-800">
                    <h2 class="text-xl font-bold mb-4">Live Previews</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="p-3 rounded-lg bg-gray-100 dark:bg-gray-700">
                            <p class="text-sm font-semibold mb-2">Browser Tab (Light)</p>
                            <div class="flex items-center p-2 bg-white rounded-md shadow-inner">
                                <canvas id="preview16" width="16" height="16" class="mr-2"></canvas>
                                <span class="text-xs text-gray-700">toolsTree | Your Title Here</span>
                            </div>
                        </div>
                        <div class="p-3 rounded-lg bg-gray-100 dark:bg-gray-700">
                            <p class="text-sm font-semibold mb-2">Browser Tab (Dark)</p>
                            <div class="flex items-center p-2 bg-gray-800 rounded-md shadow-inner">
                                <canvas id="preview32" width="16" height="16" class="mr-2"></canvas>
                                <span class="text-xs text-gray-200">toolsTree | Your Title Here</span>
                            </div>
                        </div>
                    </div>
                </div>
                 <div class="bg-white p-6 rounded-xl shadow-xl dark:bg-gray-900 border dark:border-gray-800">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-xl font-bold">Your HTML Code</h2>
                        <button id="copyBtn" class="p-2 rounded-md text-gray-500 hover:text-tt-primary transition-colors">
                            <i data-lucide="copy" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <pre class="bg-gray-100 dark:bg-gray-900/50 p-4 rounded-lg text-xs overflow-x-auto"><code id="htmlCodeBlock" class="language-html text-gray-700 dark:text-gray-200">
                        &lt;!-- Generate your kit to see the code here --&gt;
                    </code></pre>
                </div>
            </div>
        </div>
        
        <section class="mt-10 bg-white p-6 rounded-xl shadow-lg dark:bg-gray-900 border border-gray-100 dark:border-gray-800 space-y-6">
            <div>
                <h2 class="text-2xl font-bold mb-3 text-gray-900 border-b pb-2 dark:text-gray-100 dark:border-gray-800">The Easiest Way to Create a Complete Favicon Set</h2>
                <div class="space-y-4 text-gray-700 dark:text-gray-300">
                    <p>Stop generating just a single `.ico` file! This tool creates the full set of icons modern browsers and devices need, ensuring your website looks sharp everywhere. What makes this generator unique:</p>
                    <ul class="list-disc list-inside ml-5 space-y-2 mt-2">
                        <li>
                            <strong class="font-medium text-gray-900 dark:text-gray-100">3 Input Modes:</strong> Start from a high-res image, a simple emoji, or choose from thousands of professional Lucide icons. Perfect for any project, from complex brands to quick prototypes.
                        </li>
                        <li>
                            <strong class="font-medium text-gray-900 dark:text-gray-100">Client-Side Privacy:</strong> All image processing happens directly in your browser. Your images are never uploaded, ensuring 100% privacy and security.
                        </li>
                        <li>
                            <strong class="font-medium text-gray-900 dark:text-gray-100">Complete Kit Generation:</strong> Get everything you need in one `.zip` file: multi-size PNGs, Apple Touch Icon, and a `site.webmanifest` file for PWAs.
                        </li>
                         <li>
                            <strong class="font-medium text-gray-900 dark:text-gray-100">Instant HTML Code:</strong> Copy the exact HTML code needed to implement your new favicons directly into your website's `<head>`.
                        </li>
                    </ul>
                </div>
            </div>
        </section>
        <section class="mt-10 bg-white p-6 rounded-xl shadow-lg dark:bg-gray-900 border border-gray-100 dark:border-gray-800 space-y-6">
            <div>
                <h2 class="text-2xl font-bold mb-3 text-gray-900 border-b pb-2 dark:text-gray-100 dark:border-gray-800">How to Use the Favicon Generator</h2>
                <ol class="list-decimal list-inside text-gray-600 space-y-2 dark:text-gray-300">
                    <li><b>Select Source:</b> Choose between uploading a high-res image, typing a single emoji, or searching for a Lucide icon.</li>
                    <li><b>Customize Colors:</b> Set the icon/emoji color and the background color. You can also opt for a transparent background.</li>
                    <li><b>Generate Kit:</b> Click the "Generate & Download Kit" button. A `.zip` file containing all your icons and the manifest file will be downloaded.</li>
                    <li><b>Implement:</b> Unzip the file and place the contents in the root directory of your website. Copy the provided HTML code and paste it into the `<head>` section of your website's pages.</li>
                </ol>
            </div>
            <div>
                <h2 class="text-2xl font-bold mb-3 text-gray-900 border-b pb-2 dark:text-gray-100 dark:border-gray-800">Why a Full Favicon Kit Matters</h2>
                 <p class="text-gray-600 mb-4 dark:text-gray-300">A single `favicon.ico` is no longer enough for the modern web. To ensure your brand looks crisp and professional everywhere, you need a comprehensive set of icons for different platforms, browsers, and devices.</p>
                <ul class="list-disc list-inside text-gray-600 space-y-2 ml-4 dark:text-gray-300">
                    <li><b>Browser Tabs:</b> Standard 16x16 and 32x32 icons for crystal-clear display on all screens.</li>
                    <li><b>Apple Devices:</b> An `apple-touch-icon.png` is essential for users who add your website to their iPhone or iPad home screen.</li>
                    <li><b>Android & Chrome:</b> High-resolution icons and a `site.webmanifest` file are crucial for home screen shortcuts and creating a native-like Progressive Web App (PWA) experience.</li>
                </ul>
            </div>
             <div>
                <h2 class="text-2xl font-bold mb-3 text-gray-900 border-b pb-2 dark:text-gray-100 dark:border-gray-800">Frequently Asked Questions (FAQs)</h2>
                <div class="space-y-3 text-sm">
                    <details class="group"><summary class="flex justify-between items-center font-medium cursor-pointer p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700"><span>What is the best format for the source image?</span><span class="transition group-open:rotate-180"><i data-lucide="chevron-down" class="w-4 h-4"></i></span></summary><p class="text-gray-600 mt-2 p-2 dark:text-gray-300">For the best results, use a vector format like <strong>SVG</strong>. If you don't have an SVG, a high-resolution <strong>PNG</strong> (at least 512x512 pixels) with a transparent background is the next best choice. This allows the generator to scale the image down without losing quality.</p></details>
                    <details class="group"><summary class="flex justify-between items-center font-medium cursor-pointer p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700"><span>What is a `site.webmanifest` file?</span><span class="transition group-open:rotate-180"><i data-lucide="chevron-down" class="w-4 h-4"></i></span></summary><p class="text-gray-600 mt-2 p-2 dark:text-gray-300">The `site.webmanifest` is a JSON file that tells the browser about your web application and how it should behave when 'installed' on a user's mobile or desktop device. It includes information like the app's name, icons, start URL, and theme colors, which are essential for Progressive Web Apps (PWAs).</p></details>
                    <details class="group"><summary class="flex justify-between items-center font-medium cursor-pointer p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700"><span>Where do I upload the generated files?</span><span class="transition group-open:rotate-180"><i data-lucide="chevron-down" class="w-4 h-4"></i></span></summary><p class="text-gray-600 mt-2 p-2 dark:text-gray-300">For best practice, all the generated files (e.g., `apple-touch-icon.png`, `site.webmanifest`, etc.) should be placed in the <strong>root directory</strong> of your website. This is the main folder, the same place your `index.html` file usually lives.</p></details>
                    <details class="group">
                        <summary class="flex justify-between items-center font-medium cursor-pointer p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                            <span>How does the Emoji mode work?</span>
                            <span class="transition group-open:rotate-180"><i data-lucide="chevron-down" class="w-4 h-4"></i></span>
                        </summary>
                        <p class="text-gray-600 mt-2 p-2 dark:text-gray-300">The tool uses your browser's built-in font rendering to draw the emoji onto a canvas. It then exports this canvas image in all the required sizes. Using a single emoji character generally gives the clearest result.</p>
                    </details>
                    <details class="group">
                        <summary class="flex justify-between items-center font-medium cursor-pointer p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                            <span>What are Lucide Icons?</span>
                            <span class="transition group-open:rotate-180"><i data-lucide="chevron-down" class="w-4 h-4"></i></span>
                        </summary>
                        <p class="text-gray-600 mt-2 p-2 dark:text-gray-300">Lucide is a popular open-source icon library (<a href="https://lucide.dev" target="_blank" class="text-tt-primary hover:underline">lucide.dev</a>) offering thousands of clean, consistent SVG icons. This tool lets you search and select any Lucide icon directly, color it, and generate a full favicon set from it â€“ perfect for developer projects or simple websites.</p>
                    </details>
                </div>
            </div>
        </section>
    </main>
    
    <canvas id="hidden-canvas" class="hidden"></canvas>
    
    <script src="../javascript/globals.js" defer></script>
    <script>
    
    let debounceTimer;
    let currentSearchResults = [];
    let currentIconPage = 0;
    const ICONS_PER_PAGE = 200;

    document.addEventListener('DOMContentLoaded', () => {
        if (typeof window.injectLayout === 'function') {
            window.injectLayout(false);
        }
        if (window.lucide) {
            lucide.createIcons();
        }

        const ui = {
            imageUpload: document.getElementById('imageUpload'), uploadPrompt: document.getElementById('uploadPrompt'),
            imagePreview: document.getElementById('imagePreview'),
            bgColorPicker: document.getElementById('bgColor'), bgColorHex: document.getElementById('bgColorHex'),
            fgColorPicker: document.getElementById('fgColor'), fgColorHex: document.getElementById('fgColorHex'),
            fgColorLabel: document.getElementById('fgColorLabel'),
            generateBtn: document.getElementById('generateBtn'), resultsPanel: document.getElementById('resultsPanel'),
            htmlCodeBlock: document.getElementById('htmlCodeBlock'), copyBtn: document.getElementById('copyBtn'),
            preview16: document.getElementById('preview16').getContext('2d'),
            preview32: document.getElementById('preview32').getContext('2d'), 
            modeRadios: document.querySelectorAll('input[name="sourceMode"]'),
            imageMode: document.getElementById('imageMode'), emojiMode: document.getElementById('emojiMode'), iconMode: document.getElementById('iconMode'),
            emojiInput: document.getElementById('emojiInput'), iconSearch: document.getElementById('iconSearch'),
            iconGrid: document.getElementById('iconGrid'), 
            loadMoreBtn: document.getElementById('loadMoreBtn'),
            selectedIconPreview: document.getElementById('selectedIconPreview'),
            lucideLink: document.getElementById('lucideLink'),
            statusText: document.getElementById('statusText'),
            transparentBg: document.getElementById('transparentBg')
        };
        const hiddenCanvas = document.createElement('canvas');
        
        let sourceImage = null;
        let selectedIcon = null;
        let activeMode = 'image';

        async function drawSourceToCanvas(ctx, size, drawBackground = true) {
            const bgColor = ui.bgColorPicker.value;
            const fgColor = ui.fgColorPicker.value;

            ctx.clearRect(0, 0, size, size);

            if (drawBackground) {
                ctx.fillStyle = bgColor;
                ctx.fillRect(0, 0, size, size);
            }

            let drawPromise = Promise.resolve(); 

            if (activeMode === 'image' && sourceImage) {
                ctx.drawImage(sourceImage, 0, 0, size, size);
            }
            else if (activeMode === 'emoji' && ui.emojiInput.value) {
                const emoji = ui.emojiInput.value.trim();
                ctx.font = `${size * 0.8}px sans-serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(emoji, size / 2, size / 2 + size * 0.05); 
            }
            else if (activeMode === 'icon' && selectedIcon) {
                const iconNode = lucide.icons[selectedIcon];
                if (!iconNode) return Promise.reject("Selected icon node not found");

                const svgElement = lucide.createElement(iconNode);
                const iconSize = size * 0.8;
                svgElement.setAttribute('width', iconSize);
                svgElement.setAttribute('height', iconSize);
                svgElement.setAttribute('stroke', fgColor);
                const iconSVGString = svgElement.outerHTML;

                const img = new Image();
                const svgDataURL = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(iconSVGString)));

                drawPromise = new Promise((resolve, reject) => {
                    img.onload = () => {
                        const padding = size * 0.1;
                        ctx.drawImage(img, padding, padding, iconSize, iconSize);
                        resolve();
                    };
                    img.onerror = reject;
                    img.src = svgDataURL;
                });
            }

            return drawPromise; 
        }

        async function updatePreviews() {
            ui.preview16.clearRect(0, 0, 16, 16);
            ui.preview32.clearRect(0, 0, 16, 16); 
            
            hiddenCanvas.width = 32;
            hiddenCanvas.height = 32;
            const ctx = hiddenCanvas.getContext('2d');

            await drawSourceToCanvas(ctx, 32, !ui.transparentBg.checked); 

            ui.preview16.drawImage(hiddenCanvas, 0, 0, 16, 16);
            ui.preview32.drawImage(hiddenCanvas, 0, 0, 16, 16);

            let canGenerate = false;
            if (activeMode === 'image') canGenerate = !!sourceImage;
            else if (activeMode === 'emoji') canGenerate = !!ui.emojiInput.value.trim();
            else if (activeMode === 'icon') canGenerate = !!selectedIcon;
            ui.generateBtn.disabled = !canGenerate;
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    sourceImage = new Image();
                    sourceImage.onload = () => {
                        ui.imagePreview.src = e.target.result;
                        ui.imagePreview.classList.remove('hidden');
                        ui.uploadPrompt.classList.add('hidden');
                        updatePreviews();
                    };
                    sourceImage.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }
                
        function renderIconBatch() {
            const fgColor = ui.fgColorPicker.value;
            const start = currentIconPage * ICONS_PER_PAGE;
            const end = start + ICONS_PER_PAGE;
            
            const batch = currentSearchResults.slice(start, end);

            if (start === 0 && batch.length === 0) {
                const query = ui.iconSearch.value.trim();
                if (query !== '') {
                    ui.iconGrid.innerHTML = `<p class="col-span-6 text-center text-gray-500">No icons found for "${query}".</p>`;
                } else {
                    ui.iconGrid.innerHTML = `<p class="col-span-6 text-center text-gray-500">Search to see icons (e.g., "star", "user")</p>`;
                }
                ui.loadMoreBtn.classList.add('hidden');
                return;
            }
            
            try {
                for (const name of batch) {
                    const iconNode = lucide.icons[name]; 
                    if (!iconNode) continue; 

                    const svgElement = lucide.createElement(iconNode);
                    svgElement.setAttribute('width', 24);
                    svgElement.setAttribute('height', 24);
                    svgElement.setAttribute('stroke', fgColor);
                    const iconSVGString = svgElement.outerHTML; 

                    const iconEl = document.createElement('div');
                    iconEl.className = 'p-1 rounded-md cursor-pointer hover:bg-tt-primary/20 transition text-center flex items-center justify-center';
                    iconEl.setAttribute('title', name);
                    iconEl.innerHTML = iconSVGString; 
                    iconEl.onclick = () => selectIcon(name);

                    ui.iconGrid.appendChild(iconEl);
                }
            } catch (error) {
                console.error("Error rendering icon batch:", error);
                ui.iconGrid.innerHTML += `<p class="col-span-6 text-center text-red-500">Error rendering icons.</p>`;
            }
            
            if (currentSearchResults.length > end) {
                ui.loadMoreBtn.classList.remove('hidden');
            } else {
                ui.loadMoreBtn.classList.add('hidden');
            }
            
            currentIconPage++;
        }

        function updateIconGrid(query = '') {
            if (typeof lucide === 'undefined' || !lucide.icons || typeof lucide.createElement !== 'function') {
                console.warn('Lucide library not ready yet. Retrying...');
                setTimeout(() => updateIconGrid(query), 200);
                ui.iconGrid.innerHTML = `<p class="col-span-6 text-center text-gray-500">Loading icons...</p>`;
                return;
            }

            ui.iconGrid.innerHTML = ''; 
            ui.loadMoreBtn.classList.add('hidden');
            currentIconPage = 0;
            const lowerQuery = query.toLowerCase().trim();

            try {
                currentSearchResults = Object.keys(lucide.icons).filter(name => {
                    return lowerQuery === '' || name.includes(lowerQuery);
                });
            } catch (error) {
                console.error("Error filtering icons:", error);
                ui.iconGrid.innerHTML = `<p class="col-span-6 text-center text-red-500">Error filtering icons.</p>`;
                return;
            }
            
            renderIconBatch();

            ui.iconGrid.scrollTop = 0;
        }

        function selectIcon(name) {
            selectedIcon = name;
            ui.selectedIconPreview.innerHTML = `Selected: <strong>${name}</strong>`;
            updatePreviews();
            ui.iconGrid.scrollTop = 0; 
        }

        function switchMode(mode) {
            activeMode = mode;
            [ui.imageMode, ui.emojiMode, ui.iconMode].forEach(el => el.classList.add('hidden'));

            const fgControls = [ui.fgColorLabel, ui.fgColorPicker.parentElement];
            if (mode === 'image' || mode === 'emoji') { // <-- Correctly hides for Emoji too
                fgControls.forEach(el => el.classList.add('hidden'));
            } else {
                fgControls.forEach(el => el.classList.remove('hidden'));
            }

            ui.imagePreview.classList.add('hidden');
            ui.uploadPrompt.classList.remove('hidden');

            if (mode === 'image') {
                ui.imageMode.classList.remove('hidden');
            } else if (mode === 'emoji') {
                ui.emojiMode.classList.remove('hidden');
            } else if (mode === 'icon') {
                ui.iconMode.classList.remove('hidden');
                updateIconGrid(ui.iconSearch.value); 
            }
            updatePreviews();
        }

        async function generateFaviconKit() {
            if (ui.generateBtn.disabled) return;
            
            ui.statusText.textContent = 'Generating... this may take a moment.';
            ui.generateBtn.disabled = true;

            const zip = new JSZip();
            const sizes = [16, 32, 48, 180, 192, 512];
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const bgColor = ui.bgColorPicker.value;
            
            const addBg = !ui.transparentBg.checked;

            for (const size of sizes) {
                canvas.width = size;
                canvas.height = size;
                
                const drawBackground = (size === 180) ? true : addBg;
                await drawSourceToCanvas(ctx, size, drawBackground);

                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                
                let filename;
                if (size === 180) filename = 'apple-touch-icon.png';
                else if (size === 192) filename = 'android-chrome-192x192.png';
                else if (size === 512) filename = 'android-chrome-512x512.png';
                else filename = `favicon-${size}x${size}.png`;
                zip.file(filename, blob);
            }
            
            const manifest = {
                name: "Your App Name",
                short_name: "App",
                icons: [
                    { src: "/android-chrome-192x192.png", sizes: "192x192", type: "image/png" },
                    { src: "/android-chrome-512x512.png", sizes: "512x512", type: "image/png" }
                ],
                theme_color: bgColor,
                background_color: bgColor,
                display: "standalone"
            };
            zip.file('site.webmanifest', JSON.stringify(manifest, null, 2));

            updateHtmlCodeBlock();
            ui.resultsPanel.classList.remove('hidden');
            
            const zipBlob = await zip.generateAsync({ type: 'blob' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(zipBlob);
            link.download = 'favicon_kit.zip';
            link.click();

            ui.statusText.textContent = 'Download started! Files added to zip.';
            ui.generateBtn.disabled = false;
        }
        
        function updateHtmlCodeBlock() {
            const code = `&lt;link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"&gt;
&lt;link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"&gt;
&lt;link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"&gt;
&lt;link rel="manifest" href="/site.webmanifest"&gt;`;
            ui.htmlCodeBlock.innerHTML = code;
        }
        
        let inputDebounceTimer;

        ui.lucideLink.addEventListener('click', () => {
            window.open('https://lucide.dev', '_blank');
        });

        ui.imageUpload.addEventListener('change', handleImageUpload);
        ui.emojiInput.addEventListener('input', () => {
            clearTimeout(inputDebounceTimer);
            inputDebounceTimer = setTimeout(updatePreviews, 200);
        });
        
        ui.iconSearch.addEventListener('input', () => {
            clearTimeout(inputDebounceTimer);
            inputDebounceTimer = setTimeout(() => {
                updateIconGrid(ui.iconSearch.value);
            }, 300);
        });
        
        ui.loadMoreBtn.addEventListener('click', renderIconBatch);
        
        const colorUpdateHandler = () => {
            clearTimeout(inputDebounceTimer);
            inputDebounceTimer = setTimeout(updatePreviews, 50);
        }
        ui.bgColorPicker.addEventListener('input', () => { ui.bgColorHex.value = ui.bgColorPicker.value.toUpperCase(); colorUpdateHandler(); });
        ui.bgColorHex.addEventListener('input', () => { ui.bgColorPicker.value = ui.bgColorHex.value; colorUpdateHandler(); });
        ui.fgColorPicker.addEventListener('input', () => { ui.fgColorHex.value = ui.fgColorPicker.value.toUpperCase(); colorUpdateHandler(); });
        ui.fgColorHex.addEventListener('input', () => { ui.fgColorPicker.value = ui.fgColorHex.value; colorUpdateHandler(); });
        
        ui.transparentBg.addEventListener('change', updatePreviews);
        ui.modeRadios.forEach(radio => radio.addEventListener('change', () => switchMode(radio.value)));
        ui.generateBtn.addEventListener('click', generateFaviconKit);
        
        ui.copyBtn.addEventListener('click', () => {
            const textToCopy = ui.htmlCodeBlock.innerText;
            if (!textToCopy || textToCopy.includes('see the code here')) {
                return; 
            }
            const originalIconHTML = '<i data-lucide="copy" class="w-4 h-4"></i>';
            const successIconHTML = '<i data-lucide="check" class="w-4 h-4 text-emerald-500"></i>';
            const copySuccess = () => {
                ui.copyBtn.innerHTML = successIconHTML;
                if (window.lucide) lucide.createIcons();
                setTimeout(() => {
                    ui.copyBtn.innerHTML = originalIconHTML;
                    if (window.lucide) lucide.createIcons();
                }, 1500);
            };
            if (navigator.clipboard && window.isSecureContext) {
                 navigator.clipboard.writeText(textToCopy)
                    .then(copySuccess)
                    .catch(err => console.error('Failed to copy: ', err));
            } else {
                const textArea = document.createElement("textarea");
                textArea.value = textToCopy;
                textArea.style.position = "absolute";
                textArea.style.left = "-9999px";
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    copySuccess();
                } catch (err) {
                    console.error('Fallback copy failed: ', err);
                }
                document.body.removeChild(textArea);
            }
        });       
        
        switchMode('image');
        updateIconGrid('');
    });
    </script>
</body>
</html>
